<!DOCTYPE html>
<html>
<head>
    <title>AgroMind Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link
    href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css"
    rel="stylesheet"
    />
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <style>
        
        body { font-family: 'Poppins', sans-serif; background-color: #f0f4f0; margin: 0; }
        .container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
        .dashboard-card { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .dashboard-card h3 { margin-top: 0; color: #2e7d32; border-bottom: 1px solid #eee; padding-bottom: 0.5rem; }
        .dashboard-grid { display: flex; flex-direction: column; gap: 1.5rem; }
        .grid-row { display: flex; flex-direction: column; gap: 1.5rem; }
        @media (min-width: 768px) { .grid-row { flex-direction: row; } .grid-item { flex: 1; } }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .top-bar h1 { color: #2e7d32; margin: 0; font-size: 1.5rem; }
        #logoutBtn { background: #f44336; color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .chat-container { text-align: center; margin-bottom: 2rem; }
        .conversation-card { background: white; border-radius: 15px; padding: 1.5rem; text-align: left; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 1.5rem; min-height: 80px; }
        .input-bar { display: flex; align-items: center; background-color: white; padding: 0.5rem; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .input-bar button { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0.5rem; color: #555; display: flex; align-items: center; justify-content: center; }
        #text-input { flex-grow: 1; border: none; outline: none; padding: 0.8rem; font-size: 1rem; font-family: 'Poppins', sans-serif; background: transparent; }
        #image-upload-input { display: none; }
        .data-point { display: flex; justify-content: space-between; padding: 0.3rem 0; align-items: center; }
        .label { color: #555; }
        .value { font-weight: 600; color: #333; text-align: right; }
        #market-list, #soil-list { list-style-type: none; padding: 0; margin: 0; }
        #market-list { flex-grow: 1; overflow-y: auto; max-height: 150px; }
        #market-list li, #soil-list li { font-size: 0.9rem; padding: 0.2rem 0; display: flex; justify-content: space-between; }
        #map { height: 400px; width: 100%; border-radius: 8px; margin-bottom: 1rem; }
        .forecast-container { display: flex; justify-content: space-between; text-align: center; }
        .forecast-day { flex: 1; padding: 10px; }
        .forecast-day img { width: 50px; height: 50px; }
        .forecast-temp { font-weight: 600; }
        #add-crop-form { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; display: flex; gap: 0.5rem; align-items: center; }
        #add-crop-form input { flex-grow: 1; padding: 0.6rem; border: 1px solid #ddd; border-radius: 8px;  }
        #add-crop-form button { padding: 0.6rem 1rem; border: none; background-color: #2e7d32; color: white; border-radius: 8px; cursor: pointer; font-weight: 500; }
        .crop-actions button { background: none; border: none; cursor: pointer; color: #757575; font-size: 1rem; margin-left: 0.5rem; }
        .crop-actions button.delete-btn:hover { color: #f44336; }
        .crop-actions button.edit-btn:hover { color: #2e7d32; }
        .crop-details { flex-grow: 1; }
        .crop-details.editing input { padding: 0.4rem; border: 1px solid #ccc; border-radius: 4px; }
         body { font-family: 'Poppins', sans-serif; background-color: #f0f4f0; margin: 0; }
        .container { max-width: 900px; margin: 2rem auto; padding: 1rem; }
        .dashboard-card { background: white; border-radius: 15px; padding: 1.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.05); display: flex; flex-direction: column; }
        .input-bar { display: flex; align-items: center; background-color: white; padding: 0.5rem; border-radius: 50px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .camera-modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; background-color: rgba(0,0,0,0.7);
            justify-content: center; align-items: center;
        }
        .camera-view { background: white; padding: 1rem; border-radius: 15px; text-align: center; }
        #camera-feed { width: 100%; max-width: 500px; border-radius: 10px; margin-bottom: 1rem; }
        .camera-controls button { padding: 0.8rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; margin: 0 0.5rem; }
        #capture-btn { background-color: #2e7d32; color: white; }
        #close-camera-btn { background-color: #f44336; color: white; }
        #crop-list {
                        max-height: 150px; 
                        overflow-y: auto;  
                        flex-grow: 1;      
                    }
        </style>
</head>
<body>
    <div class="top-bar">
        <h1>AgroMind</h1>
<button id="muteBtn">ðŸ”Š</button>
        <button id="logoutBtn">Logout</button>
        

    </div>

    <div class="container">
           

        <div class="chat-container">
            <div class="conversation-card">
                <p><strong>AgroMind says:</strong> <span id="aiResponse"></span></p><hr><p><strong>You said:</strong> <span id="userQuery"></span></p>
                <div class="input-bar" style="overflow: hidden;">
                <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                <button id="image-upload-btn" title="Attach Image"><i class="ri-attachment-line"></i></button>
                <button id="camera-btn" title="Take Photo"><i class="ri-camera-line"></i></button>
                <button id="speak-btn" title="Ask with Voice"><i class="ri-mic-line"></i></button>
                <input type="text" id="text-input" placeholder="Ask about your farm or a photo...">
                
            
            </div>
            
        </div>
            </div>

        <div class="dashboard-grid">
            <div class="grid-row" style="width: 100%; overflow: auto;">
                <div class="dashboard-card grid-item" id="profile-card">
                    <h3>Farmer Profile</h3>

                    <div class="data-point"><span class="label">Name:</span> <span class="value" id="farmer-name">Loading...</span></div>
                    <div class="data-point"><span class="label">Region:</span> <span class="value" id="farmer-region">Loading...</span></div>
                </div>
                <div class="dashboard-card grid-item" id="my-crops-card">
                    <h3>My Crops</h3>
                    <ul id="crop-list" style="margin: 0%;"><li class="label">Loading crops...</li></ul>
                    <form id="add-crop-form" style="margin: 0%; overflow: scroll;" >
                        <input type="text" id="crop-name-input" placeholder="Crop Name" required style="padding-right: 0%;"> 
                        <input type="date" id="planting-date-input" required >
                        <button type="submit">Add</button>
                    </form>
                </div>
                <div class="dashboard-card grid-item" id="market-card">
                    <h3>Latest Mandi Prices</h3>
                    <ul id="market-list"><li>Loading...</li></ul>
                </div>
            </div>
            <div class="grid-row">
                <div class="dashboard-card grid-item" id="weather-card" style="overflow: scroll;">
                    <h3>5-Day Weather Forecast</h3>
                    <div id="forecast-container" class="forecast-container">
                        <p>Loading forecast...</p>
                    </div>
                </div>
            </div>
            <div class="grid-row">
                <div class="dashboard-card grid-item" id="map-card">
                    <h3>SoilGrids Analysis</h3>
                    <p>Use the drawing tools on the map to analyze your field.</p>
                    <div id="map"></div>
                    <div id="analysis-results"></div>
                </div>
            </div>
        
        </div>
        <div id="camera-modal" class="camera-modal">
        <div class="camera-view">
            <h3>Camera</h3>
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="photo-canvas" style="display:none;"></canvas>
            <div class="camera-controls">
                <button id="capture-btn">Take Photo</button>
                <button id="close-camera-btn">Close</button>
            </div>
        </div>
    </div>

    <script>
        const farmerId = localStorage.getItem('farmer_id');
        if (!farmerId) { window.location.href = './login.html'; }
        
        const farmerNameElem = document.getElementById('farmer-name');
        const farmerRegionElem = document.getElementById('farmer-region');
        const forecastContainer = document.getElementById('forecast-container');
        const marketList = document.getElementById('market-list');
        const analysisResultsElem = document.getElementById('analysis-results');
        const logoutBtn = document.getElementById('logoutBtn');
        const userQueryElem = document.getElementById('userQuery');
        const aiResponseElem = document.getElementById('aiResponse');
        const imageUploadInput = document.getElementById('image-upload-input');
        const imageUploadBtn = document.getElementById('image-upload-btn');
         const cameraBtn = document.getElementById('camera-btn');
            const cameraModal = document.getElementById('camera-modal');
            const cameraFeed = document.getElementById('camera-feed');
            const photoCanvas = document.getElementById('photo-canvas');
             const captureBtn = document.getElementById('capture-btn');
            const closeCameraBtn = document.getElementById('close-camera-btn');
        const textInput = document.getElementById('text-input');
        const speakBtn = document.getElementById('speak-btn');
        const cropList = document.getElementById('crop-list');
        const addCropForm = document.getElementById('add-crop-form');
        const cropNameInput = document.getElementById('crop-name-input');
        const plantingDateInput = document.getElementById('planting-date-input');

        
        
        let map;
        let uploadedImageBase64 = null;
        let voices = [];

        function updateProfileCard(farmer) {
            if (farmer) {
                farmerNameElem.textContent = farmer.name;
                farmerRegionElem.textContent = farmer.region;
            }
        }
        

        function updateWeatherCard(weather) {
            forecastContainer.innerHTML = '';
            if (weather && weather.forecast && weather.forecast.length > 0) {
                weather.forecast.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.classList.add('forecast-day');
                    const date = new Date(day.date);
                    date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
                    const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                    dayElement.innerHTML = `
                        <div><strong>${dayName}</strong></div>
                        <img src="http://openweathermap.org/img/wn/${day.icon}.png" alt="${day.description}">
                        <div>${day.description}</div>
                        <div class="forecast-temp">${Math.round(day.temp_max)}Â° / ${Math.round(day.temp_min)}Â°</div>
                    `;
                    forecastContainer.appendChild(dayElement);
                });
            } else {
                forecastContainer.innerHTML = '<p>Could not load forecast data.</p>';
            }
        }

        function updateMarketList(market) {
            marketList.innerHTML = '';
            if (market && market.top_prices && market.top_prices.length > 0) {
                market.top_prices.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<span class="label">${item.commodity}</span> <span class="value">â‚¹${item.modal_price}</span>`;
                    marketList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.textContent = 'Prices for your area are not listed yet.';
                marketList.appendChild(listItem);
            }
        }
          

        function updateCropCard(crops, cropList) {
            cropList.innerHTML = '';
            if (crops && crops.length > 0) {
                crops.forEach(crop => {
                    const listItem = document.createElement('li');
                    listItem.setAttribute('data-id', crop._id); // Add data-id for easy access
                    
                    const plantDate = new Date(crop.plantingDate);
                    const formattedDate = plantDate.toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
                    // ISO format (YYYY-MM-DD) is needed for the date input value
                    const isoDate = plantDate.toISOString().split('T')[0];

                    listItem.innerHTML = `
                        <div class="crop-details">
                            <span class="label crop-name-display">${crop.cropName}</span>
                            <span class="value">Planted: ${formattedDate}</span>
                        </div>
                        <div class="crop-actions">
                            <button class="edit-btn" data-id="${crop._id}"><i class="ri-pencil-line"></i></button>
                            <button class="delete-btn" data-id="${crop._id}"><i class="ri-delete-bin-line"></i></button>
                        </div>
                    `;
                    cropList.appendChild(listItem);
                });
            } else {
                cropList.innerHTML = '<li class="label">No crops added yet.</li>';
            }
        }
        
        async function fetchCrops() {
            const response = await fetch(`/api/crops/${farmerId}`);
            return await response.json();
        }





        
        window.onload = async function() {
            const cropList = document.getElementById('crop-list');
            const addCropForm = document.getElementById('add-crop-form');
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri'
            });
            const streetsLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            map = L.map('map', {
                center: [20.5937, 78.9629],
                zoom: 5,
                layers: [streetsLayer]
            });
            
            const baseMaps = { "Streets": streetsLayer, "Satellite": satelliteLayer };
            L.control.layers(baseMaps).addTo(map);

            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            const drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems, remove: true },
                draw: {
                    polygon: true,
                    rectangle: true,
                    circle: true,
                    marker: false,
                    polyline: false,
                    circlemarker: false
                }
            });
            map.addControl(drawControl);

            map.on(L.Draw.Event.CREATED, async function (event) {
                const layer = event.layer;
                drawnItems.clearLayers();
                drawnItems.addLayer(layer);
                analysisResultsElem.innerHTML = 'Analyzing drawn area with SoilGrids...';
                
                const bounds = layer.getBounds();
                const bbox = [bounds.getWest(), bounds.getSouth(), bounds.getEast(), bounds.getNorth()];
                fetchSoilGridsData(bbox);
            });

            const initialData = await fetchDashboardData();
            if (initialData) {
                updateProfileCard(initialData.farmer);
                updateWeatherCard(initialData.weather);
                updateMarketList(initialData.market);
                updateCropCard(initialData.crops, cropList);
                if (initialData.soil) {
                    displaySoilGridsData(initialData.soil);
                }
            }
            detectAndSyncLocation(); 
        };

       



        async function fetchDashboardData() {
            try {
                const response = await fetch(`/api/dashboard/${farmerId}`);
                if (!response.ok) return null;
                return await response.json();
            } catch (error) {
                console.error("Error fetching dashboard data:", error);
                return null;
            }
        }

        async function detectAndSyncLocation() {
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    map.setView([latitude, longitude], 13);
                    L.circleMarker([latitude, longitude], { color: 'blue', fillColor: '#30f', fillOpacity: 0.5, radius: 8 }).addTo(map).bindPopup("Your Current Location");
                    syncWeatherAndMarket(latitude, longitude);
                },
                () => {
                    syncWeatherAndMarket(null, null);
                }
            );
        }

        async function syncWeatherAndMarket(lat, lon) {
            const weatherBody = { farmer_id: farmerId };
            if (lat && lon) {
                weatherBody.lat = lat;
                weatherBody.lon = lon;
            } else { return; }
            fetch('/api/weather/sync', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(weatherBody)
            }).then(res => res.json()).then(data => {
                if (data && !data.error) updateWeatherCard(data);
            });

            const marketBody = { farmer_id: farmerId };
            fetch('/api/market/sync', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(marketBody)
            }).then(res => res.json()).then(data => {
                if (data && !data.error) updateMarketList(data);
            });
        }

        async function fetchSoilGridsData(bbox) {
            try {
                const response = await fetch('/api/soilgrids-stats', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ farmer_id: farmerId, bbox })
                });
                if (!response.ok) throw new Error('SoilGrids server error');
                const data = await response.json();
                displaySoilGridsData(data);
            } catch (error) {
                console.error("Error fetching SoilGrids data:", error);
                analysisResultsElem.innerHTML = '<p>The SoilGrids server is currently unavailable or the area is too large.</p>';
            }
        }
        
        function displaySoilGridsData(data) {
            let resultsHtml = '<h5>SoilGrids Area Analysis (0-5cm depth)</h5><ul id="soil-list">';
            resultsHtml += `<li><span class="label">Avg. pH:</span> <span class="value">${data.ph.toFixed(2)}</span></li>`;
            resultsHtml += `<li><span class="label">Avg. Organic Carbon:</span> <span class="value">${data.soc.toFixed(2)} g/kg</span></li>`;
            resultsHtml += `<li><span class="label">Avg. Clay Content:</span> <span class="value">${data.clay.toFixed(2)} g/kg</span></li>`;
            resultsHtml += '</ul>';
            analysisResultsElem.innerHTML = resultsHtml;
        }

 

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('farmer_id');
            window.location.href = '/login.html';
        });

        imageUploadBtn.addEventListener('click', () => {
            imageUploadInput.click();
        });

        imageUploadInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onloadend = () => {
                uploadedImageBase64 = reader.result.split(',')[1];
                alert('Image selected! Now type or speak your question about it.');
                textInput.placeholder = "Image attached! Ask your question.";
            };
            reader.readAsDataURL(file);
        });
 cameraBtn.addEventListener('click', async () => {
                cameraModal.style.display = 'flex';
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    cameraFeed.srcObject = stream;
                } catch (error) {
                    console.error("Error accessing camera:", error);
                    alert("Could not access camera. Please ensure you have given permission.");
                    cameraModal.style.display = 'none';
                }
            });

            function stopCamera() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                cameraModal.style.display = 'none';
            }
            closeCameraBtn.addEventListener('click', stopCamera);
            
            captureBtn.addEventListener('click', () => {
                const context = photoCanvas.getContext('2d');
                photoCanvas.width = cameraFeed.videoWidth;
                photoCanvas.height = cameraFeed.videoHeight;
                context.drawImage(cameraFeed, 0, 0, photoCanvas.width, photoCanvas.height);
                uploadedImageBase64 = photoCanvas.toDataURL('image/jpeg').split(',')[1];
                alert('Photo captured! Now type or speak your question.');
                textInput.placeholder = "Photo captured! Ask your question.";
                stopCamera();
            });

        
        textInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                const query = textInput.value;
                if (query) {
                    userQueryElem.textContent = query;
                    getAIResponse(query);
                }
            }
        });

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();
        recognition.lang = 'hi-IN';



        speakBtn.addEventListener('click', () => {
            speakBtn.disabled = true;
            recognition.start();
        });

        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            userQueryElem.textContent = transcript;
            getAIResponse(transcript);
        };

        recognition.onend = () => {
            speakBtn.disabled = false;
        };
         
        cropList.addEventListener('click', async (e) => {
    const target = e.target.closest('button');
    if (!target) return;

    const cropId = target.dataset.id;

    // YOUR DEBUGGING SUGGESTION:
    console.log('Attempting to act on crop with ID:', cropId);
    if (!cropId) {
        alert('Error: Could not find the Crop ID. Cannot proceed.');
        return;
    }
    
    // Handle DELETE
    if (target.classList.contains('delete-btn')) {
        if (confirm('Are you sure you want to delete this crop?')) {
            await fetch(`/api/crops/${cropId}`, { method: 'DELETE' });
            const updatedCrops = await fetchCrops();
            updateCropCard(updatedCrops, cropList);
        }
    }

    // Handle EDIT / SAVE
    if (target.classList.contains('edit-btn')) {
        const listItem = target.closest('li');
        const detailsDiv = listItem.querySelector('.crop-details');
        
        if (detailsDiv.classList.contains('editing')) {
            const nameInput = listItem.querySelector('.edit-name-input');
            const dateInput = listItem.querySelector('.edit-date-input');
            
            await fetch(`/api/crops/${cropId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cropName: nameInput.value, plantingDate: dateInput.value })
            });
            const updatedCrops = await fetchCrops();
            updateCropCard(updatedCrops, cropList);
        } 
        else {
            const currentName = listItem.querySelector('.crop-name-display').textContent;
            const originalCrop = (await fetchCrops()).find(c => c._id === cropId);
            const isoDate = new Date(originalCrop.plantingDate).toISOString().split('T')[0];

            detailsDiv.classList.add('editing');
            detailsDiv.innerHTML = `
                <input type="text" class="edit-name-input" value="${currentName}">
                <input type="date" class="edit-date-input" value="${isoDate}">
            `;
            target.innerHTML = '<i class="ri-check-line"></i>'; // Change icon to Save
        }
    }
});



          addCropForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const cropName = cropNameInput.value;
                const plantingDate = plantingDateInput.value;
                if (!cropName || !plantingDate) { alert('Please enter both crop name and planting date.'); return; }
                try {
                    const response = await fetch('/api/crops', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ farmer_id: farmerId, cropName, plantingDate }) });
                    if (!response.ok) throw new Error('Failed to add crop.');
                    const updatedCrops = await (await fetch(`/api/crops/${farmerId}`)).json();
                    updateCropCard(updatedCrops, cropList);
                    cropNameInput.value = '';
                    plantingDateInput.value = '';
                } catch (error) { console.error('Error adding crop:', error); alert('Could not add crop. Please try again.'); }
            });






        // This function ensures the `voices` array is populated
        function populateVoiceList() {
            if(typeof speechSynthesis === 'undefined') {
                return;
            }
            voices = speechSynthesis.getVoices();
        }
        populateVoiceList();
        if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
            speechSynthesis.onvoiceschanged = populateVoiceList;
        }

        async function getAIResponse(query) {
            aiResponseElem.textContent = "â€¢â€¢â€¢â—â—â—â€¢â€¢â€¢";
            
            const payload = {
                farmer_id: farmerId,
                query: query,
                image: uploadedImageBase64
            };

            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) { throw new Error("Server error during query."); }

                const data = await response.json();
                const responseText = data.response;
                const responseLang = data.language; // This should be 'hi-IN' from the server

                aiResponseElem.textContent = responseText;
                
                 textInput.value = '';
                uploadedImageBase64 = null;
                textInput.placeholder = "Ask about your farm or an image...";
                imageUploadInput.value = '';

                // --- YOUR SUGGESTED VOICE LOGIC ---
                const utterance = new SpeechSynthesisUtterance(responseText);
                // Force Hindi language
                utterance.lang = "hi-IN";
                
                // Try to pick a female Hindi voice
                let chosenVoice = voices.find(v => v.lang === "hi-IN" && v.name.toLowerCase().includes("female"));
                
                // If not found, just take any Hindi voice
                if (!chosenVoice) {
                    chosenVoice = voices.find(v => v.lang === "hi-IN");
                }
                
                // Apply chosen voice if available
                if (chosenVoice) {
                    utterance.voice = chosenVoice;
                }
                
                // Optionally adjust pitch/rate to sound more natural
                utterance.pitch = 1.1;
                utterance.rate = 1;

                speechSynthesis.speak(utterance);

            } catch (error) {
                console.error("Error in getAIResponse:", error);
                aiResponseElem.textContent = "A critical error occurred.";
            }
        }
        const muteBtn = document.getElementById("muteBtn");
let isMuted = false;
let originalSpeak = speechSynthesis.speak; // keep original

muteBtn.addEventListener("click", () => {
  isMuted = !isMuted;

  if (isMuted) {
    speechSynthesis.cancel();          // stop any current speech
    speechSynthesis.speak = function() {}; // block all future speech
    muteBtn.textContent = "ðŸ”‡";        // update button
  } else {
    speechSynthesis.speak = originalSpeak; // restore normal speech
    muteBtn.textContent = "ðŸ”Š";        // update button
  }
});
        
    </script>
</body>
</html>